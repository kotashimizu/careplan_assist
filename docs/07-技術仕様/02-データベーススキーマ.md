# データベース設計テンプレート

## 📋 このドキュメントについて

これは汎用的なデータベース設計のテンプレートです。あなたのプロジェクトに合わせて、テーブル構造を設計してください。

## 🎯 設計の基本方針

1. **正規化**: データの重複を避ける
2. **拡張性**: 将来の機能追加を考慮
3. **パフォーマンス**: 適切なインデックス設計
4. **セキュリティ**: RLS（Row Level Security）の活用

## 📊 基本的なテーブル構造

### 1. users（ユーザー）
ほとんどのアプリケーションで必要な基本テーブル

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email TEXT UNIQUE NOT NULL,
  name TEXT,
  avatar_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- RLSを有効化
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- ポリシー例：自分の情報のみ参照可能
CREATE POLICY "Users can view own data" ON users
  FOR SELECT USING (auth.uid() = id);
```

### 2. profiles（プロフィール）
ユーザーの追加情報（拡張用）

```sql
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  bio TEXT,
  website TEXT,
  location TEXT,
  -- あなたのアプリに必要なフィールドを追加
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);
```

### 3. [your_main_entity]（メインエンティティ）
あなたのアプリケーションの中心となるデータ

```sql
-- 例：ECサイトの場合
CREATE TABLE products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  description TEXT,
  price DECIMAL(10, 2) NOT NULL,
  stock INTEGER DEFAULT 0,
  category_id UUID REFERENCES categories(id),
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- 例：ブログの場合
CREATE TABLE posts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  published BOOLEAN DEFAULT false,
  author_id UUID REFERENCES users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- 例：タスク管理の場合
CREATE TABLE tasks (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  title TEXT NOT NULL,
  description TEXT,
  status TEXT DEFAULT 'pending',
  priority INTEGER DEFAULT 0,
  due_date DATE,
  assigned_to UUID REFERENCES users(id),
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);
```

## 🔗 リレーションシップの設計

### 1対多の関係
```sql
-- カテゴリーと商品
CREATE TABLE categories (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL
);

-- products テーブルに外部キー
ALTER TABLE products 
  ADD COLUMN category_id UUID REFERENCES categories(id);
```

### 多対多の関係
```sql
-- ユーザーとロールの関係
CREATE TABLE roles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT UNIQUE NOT NULL,
  permissions JSONB DEFAULT '{}'
);

CREATE TABLE user_roles (
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  PRIMARY KEY (user_id, role_id)
);
```

## 🚀 インデックスの設計

```sql
-- 検索でよく使用されるカラムにインデックス
CREATE INDEX idx_products_name ON products(name);
CREATE INDEX idx_products_category ON products(category_id);
CREATE INDEX idx_posts_slug ON posts(slug);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_assigned ON tasks(assigned_to);
```

## 🔐 セキュリティ設計

### Row Level Security (RLS) の例

```sql
-- 商品は誰でも見れるが、作成者のみ編集可能
CREATE POLICY "Products are viewable by everyone" ON products
  FOR SELECT USING (true);

CREATE POLICY "Products are editable by creator" ON products
  FOR UPDATE USING (auth.uid() = created_by);

-- タスクは割り当てられた人と作成者のみ参照可能
CREATE POLICY "Tasks are viewable by assignee or creator" ON tasks
  FOR SELECT USING (
    auth.uid() = assigned_to OR 
    auth.uid() = created_by
  );
```

## 📝 マイグレーション戦略

1. **初期セットアップ**
   ```sql
   -- 000_initial_schema.sql
   CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
   ```

2. **テーブル追加**
   ```sql
   -- 001_create_users.sql
   -- 002_create_products.sql
   -- 003_create_categories.sql
   ```

3. **変更管理**
   ```sql
   -- 004_add_column_to_products.sql
   ALTER TABLE products ADD COLUMN discount DECIMAL(5, 2) DEFAULT 0;
   ```

## 💡 設計のヒント

### AIに依頼する例
```
「ECサイトのデータベース設計を作ってください。
商品、カテゴリー、カート、注文の機能が必要です。」

「ブログシステムのデータベース設計を作ってください。
記事、カテゴリー、タグ、コメント機能が必要です。」

「タスク管理アプリのデータベース設計を作ってください。
プロジェクト、タスク、ユーザー、権限管理が必要です。」
```

### 考慮すべき点
1. **スケーラビリティ**: 将来のデータ量増加に対応
2. **パフォーマンス**: 適切なインデックスとクエリ最適化
3. **整合性**: 外部キー制約とトリガー
4. **監査**: created_at, updated_at の自動更新

## 🔧 Supabase固有の機能

```sql
-- リアルタイム機能を有効化
ALTER PUBLICATION supabase_realtime ADD TABLE products;

-- ストレージとの連携
CREATE POLICY "Users can upload own avatars" ON storage.objects
  FOR INSERT WITH CHECK (bucket_id = 'avatars' AND auth.uid()::text = (storage.foldername(name))[1]);
```

---

**注意**: これは汎用的なテンプレートです。あなたのプロジェクトの要件に合わせて、適切にカスタマイズしてください。