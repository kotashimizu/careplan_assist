# 🔐 AI安全運用ガイド

## 📌 なぜAIの権限制限が必要か？

AIエディター（Claude Code、Cursor等）は強力ですが、意図しない操作を防ぐために適切な制限が必要です。

### 想定されるリスク
1. **機密情報の漏洩**
   - `.env` ファイルの内容を読み取り
   - SSH鍵やAPIキーへのアクセス

2. **破壊的操作**
   - `rm -rf /` などの危険なコマンド
   - データベースの削除操作

3. **不正な外部通信**
   - 機密データの外部送信
   - 悪意のあるスクリプトのダウンロード

## 🛡️ permissions.deny による制限

### 基本的な考え方
「AIに何をさせるか」ではなく「**何をさせないか**」を明確に定義します。

### 設定ファイルの配置
```
プロジェクトルート/
├── permissions.deny    # AI権限制限ファイル
├── .env.local         # 機密情報（AIアクセス禁止）
└── src/
```

### 推奨される制限内容

#### 1. 機密ファイルの保護
```
# permissions.deny
*.env*              # 環境変数ファイル
*.pem              # 証明書
*.key              # 秘密鍵
*_rsa*             # SSH鍵
.ssh/*             # SSH設定
.aws/*             # AWSクレデンシャル
```

#### 2. 危険なコマンドの禁止
```
# 破壊的操作
bash:rm -rf        # 再帰的削除
bash:sudo          # 管理者権限
bash:chmod 777     # 過度な権限付与

# 危険なダウンロード実行
bash:curl * | bash
bash:wget * | sh
```

#### 3. Git操作の制限
```
bash:git push --force     # 強制プッシュ
bash:git reset --hard     # ハードリセット
```

## 🎯 プロジェクト別の設定

### 開発段階別の制限レベル

#### 初期開発（緩い制限）
```
# 最小限の制限のみ
*.env*
*_rsa*
bash:sudo
```

#### 本番環境（厳格な制限）
```
# 本番環境接続情報も保護
*production*
*staging*
database.yml
secrets.*
```

### チーム開発での運用
1. **permissions.deny をGit管理**
   - チーム全体で同じ制限を共有
   - レビューを通じて適切な制限を維持

2. **定期的な見直し**
   - 月1回、制限内容を確認
   - 新しいリスクに対応

## 💡 ベストプラクティス

### 1. 段階的な導入
```bash
# Step 1: 最小限から始める
echo "*.env*" > permissions.deny

# Step 2: 使いながら追加
echo "bash:sudo" >> permissions.deny

# Step 3: チームで共有
git add permissions.deny
git commit -m "AI権限制限を追加"
```

### 2. ホワイトリスト方式の検討
特に機密性の高いプロジェクトでは、「許可するもの」を明示的に定義する方が安全です。

### 3. 定期的な監査
```bash
# AIが実行したコマンドの確認
history | grep -E "(rm|sudo|curl.*bash)"

# 機密ファイルへのアクセス確認
find . -name "*.env*" -exec ls -la {} \;
```

## 🔍 トラブルシューティング

### AIが必要な操作を実行できない場合
1. **一時的な許可**
   ```bash
   # 特定の操作のみ手動実行
   npm install  # AIに任せず自分で実行
   ```

2. **制限の調整**
   ```
   # 過度に厳しい制限を緩和
   # bash:npm* → 削除（npmは安全）
   ```

### 制限が効かない場合
- AIツールが`permissions.deny`をサポートしているか確認
- ファイルの配置場所が正しいか確認
- 構文エラーがないか確認

## 📚 参考情報

### セキュリティの原則
1. **最小権限の原則**: 必要最小限の権限のみ付与
2. **多層防御**: 複数の防御策を組み合わせる
3. **定期的な見直し**: 環境の変化に応じて更新

### 関連ドキュメント
- [セキュリティ実装ガイド](./03-セキュリティ実装ガイド.md)
- [環境変数の安全な管理](./04-環境変数管理.md)

## 🎯 まとめ

AIは強力なツールですが、適切な制限なしに使用するのは危険です。`permissions.deny`を活用して、安全かつ効率的な開発環境を構築しましょう。

**重要**: セキュリティは「面倒」ではなく「投資」です。最初に適切な設定をすることで、将来の大きなトラブルを防げます。